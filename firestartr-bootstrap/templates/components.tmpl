{{ range $index, $claim := .Components }}
{{- if not $claim.Skipped }}
---
kind: ComponentClaim
version: "1.0"
type: service
lifecycle: production
system: system:{{ $.DefaultSystemName }}
owner: group:{{ $.DefaultFirestartrGroup }}
name: {{ $claim.Name }}
providers:
  github:
    description: {{ $claim.Description }}
    name: {{ default $claim.Name $claim.RepoName }}
    org: {{ $.Org }}
    visibility: private
    branchStrategy:
      name: none
      defaultBranch: {{ $claim.DefaultBranch }}
    actions:
      oidc:
        useDefault: false
        includeClaimKeys:
          - repo
    features:
      {{- range $index, $feature := $claim.Features }}
      - name: {{ $feature.Name }}
        version: {{ $feature.Version }}
      {{- end }}
    {{- if or $.HasFreePlan $claim.Secrets}}
    secrets:
      actions:
        {{- range $index, $secret := $claim.Secrets }}
        - name: {{ $secret.Name }}
          value: {{ $secret.Value }}
        {{- end }}
        {{- if $.HasFreePlan }}
        - name: FS_STATE_PEM_FILE
          value: "ref:secretsclaim:platform-secrets:fs-state-pem"
        - name: FS_CHECKS_PEM_FILE
          value: "ref:secretsclaim:platform-secrets:fs-checks-pem"
        {{- end }}
    {{- end }}
    {{- if or $.HasFreePlan $claim.Variables}}
    vars:
      actions:
        {{- range $index, $variable := $claim.Variables }}
        - name: {{ $variable.Name }}
          value: {{ $variable.Value }}
        {{- end }}
        {{- if $.HasFreePlan }}
        - name: "FIRESTARTR_CLI_VERSION"
          value: "ref:secretsclaim:platform-secrets:firestartr-cli-version"
        - name: "FS_STATE_APP_ID"
          value: "ref:secretsclaim:platform-secrets:fs-state-appid"
        - name: "FS_CHECKS_APP_ID"
          value: "ref:secretsclaim:platform-secrets:fs-checks-appid"
        {{- end }}
    {{- end }}
{{ end }}
{{ end }}
---
kind: SystemClaim
version: "1.0"
name: {{ $.DefaultSystemName }}
domain: domain:{{ $.DefaultDomainName }}
owner: group:{{ $.DefaultFirestartrGroup }}
description: "The default system of {{ $.Org }}"
---
kind: DomainClaim
version: "1.0"
name: {{ $.DefaultDomainName }}
description: "The default domain of {{ $.Org }}"
owner: group:{{ $.DefaultFirestartrGroup }}
---
kind: GroupClaim
version: "1.0"
name: {{ $.DefaultFirestartrGroup }}
description: "The default group for the firestartr application"
type: business-unit
profile:
  displayName: {{ $.DefaultFirestartrGroup }}
members: []
providers:
  github:
    name: {{ $.DefaultFirestartrGroup }}
    org: {{ $.Org }}
---
kind: SecretsClaim
lifecycle: production
name: platform-secrets
system: system:{{ $.DefaultSystemName }}
version: "1.0"
providers:
  external_secrets:
    name: platform-secrets
    secretStore:
      kind: SecretStore
      name: aws  # This will be swapped with {{ $.Org }}-firestartr-secret-store before uploading
    externalSecrets:
      refreshInterval: 24h
      secrets:
      - secretName: "prefapp-bot-pat"
        remoteRef: "/firestartr/{{ $.Org }}/prefapp-bot-pat"
      - secretName: "firestartr-cli-version"
        remoteRef: "/firestartr/{{ $.Org }}/firestartr-cli-version"
      - secretName: "fs-state-pem"
        remoteRef: "/firestartr/{{ $.Org }}/fs-{{ $.Org }}-state/pem"
      - secretName: "fs-checks-pem"
        remoteRef: "/firestartr/{{ $.Org }}/fs-{{ $.Org }}-checks/pem"
      - secretName: "fs-import-pem"
        remoteRef: "/firestartr/{{ $.Org }}/fs-{{ $.Org }}-import/pem"
      - secretName: "fs-state-appid"
        remoteRef: "/firestartr/{{ $.Org }}/fs-{{ $.Org }}-state/app-id"
      - secretName: "fs-checks-appid"
        remoteRef: "/firestartr/{{ $.Org }}/fs-{{ $.Org }}-checks/app-id"
      - secretName: "fs-import-appid"
        remoteRef: "/firestartr/{{ $.Org }}/fs-{{ $.Org }}-import/app-id"
